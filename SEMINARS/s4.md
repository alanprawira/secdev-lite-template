# S04 - DFD + STRIDE + Risk Prioritization

---

## DFD

```mermaid
flowchart LR
  %% === Trust boundaries ===
  subgraph Internet["Интернет / Внешние клиенты"]
    U[Клиент / Браузер / Мобильное]
  end

  subgraph Service["Сервис — приложение"]
    A[Public API / Auth Controller]
    S[Auth Service / Бизнес-логика]
  end

  subgraph Storage["Хранилище / Персистентный слой"]
    D[(База данных / Users и VerificationTokens)]
  end

  subgraph External["Внешние провайдеры"]
    X[Email Provider SMTP API]
  end

  %% === Основные потоки регистрации ===
  U -- "HTTPS JSON → POST /api/auth/register<br/>PII: email, password, ip<br/>[NFR-002 InputValidation, NFR-004 Privacy/PII]" --> A
  A -->|"DTO RegisterRequest + correlation_id<br/>[NFR-003 API-Contract]"| S
  S -->|"INSERT user (hash password), INSERT verification token<br/>SQL ORM<br/>[NFR-004 Privacy, Data-Integrity]"| D

  S -->|"HTTP/SMTP: email + verification token<br/>timeouts retry circuit-breaker<br/>[NFR-004 Privacy, Observability]"| X

  %% === Основные потоки верификации ===
  U -- "HTTPS → POST /api/auth/verify-email<br/>PII: email, token<br/>[NFR-001 RateLimiting, NFR-003 API-Contract]" --> A
  A -->|"DTO VerifyEmailRequest<br/>[NFR-003]"| S
  S -->|"SELECT token validation<br/>SQL ORM<br/>[Data-Integrity]"| D
  S -->|"UPDATE user.status=verified; DELETE token<br/>SQL ORM<br/>[NFR-004 Retention]"| D

  A -- "200/201 JSON или RFC7807 problem+json<br/>+ correlation_id<br/>[NFR-003, NFR-004]" --> U

  %% --- Оформление границ ---
  classDef boundary fill:#f6f6f6,stroke:#999,stroke-width:1px;
  class Internet,Service,Storage,External boundary;

  ## STRIDE Matrix

| Element | Data/Boundary | Threat (S/T/R/I/D/E) | Description | NFR link (ID) | Mitigation idea (ADR later) |
|---------|---------------|---------------------|-------------|---------------|----------------------------|
| Edge: Internet → API (/register) | JSON Request | T | Manipulation of registration data | **NFR-002** | Strict schema validation |
| Edge: Internet → API (/register) | Public Endpoint | D | DoS through large payloads | **NFR-002** | Request size limits |
| Edge: Internet → API (/verify-email) | Verification Token | S | Token replay attacks | need NFR: Token-Security | High entropy tokens |
| Edge: Internet → API (/verify-email) | Public Endpoint | D | Abuse through flooding | **NFR-001** | Rate limiting |
| Node: API Controller | Application Logs | I | PII leakage in logs | **NFR-004** | PII masking |
| Node: Auth Service | Error Handling | I | Information disclosure | **NFR-003** | RFC7807 errors |
| Edge: Service → Database | SQL Queries | T | SQL injection | **NFR-002** | Parameterized queries |
| Node: Database | Stored Data | I | PII exposure | **NFR-004** | Encryption at rest |
| Edge: Service → Email Provider | SMTP/HTTP | D | External dependency failure | need NFR: External-Resilience | Circuit breaker |

---

## Risk Prioritization L×I

### Таблица приоритизации

| Risk ID | Source (DFD/Row) | Consolidated Description | Threat | NFR link (ID) | L | Rationale-L | I | Rationale-I | Score | Decision | ADR candidate |
|---------|------------------|-------------------------|--------|---------------|--|-------------|--|-------------|-------|----------|--------------|
| **R-01** | Internet→API | DoS/abuse of public endpoints | D | **NFR-001**, **NFR-002** | 4 | Easy to exploit | 4 | Service unavailable | 16 | **Top-5** | Rate Limiting Strategy |
| **R-02** | Service→Email Provider | External service failure | D | need NFR: External-Resilience | 4 | External dependency | 4 | Registration blocked | 16 | **Top-5** | Circuit Breaker Pattern |
| **R-03** | API/Service | PII leakage in logs/errors | I | **NFR-003**, **NFR-004** | 4 | Common misconfiguration | 4 | Data exposure | 16 | **Top-5** | PII Protection |
| **R-04** | Database | Weak token security | S | need NFR: Token-Security | 3 | Implementation error | 4 | Account compromise | 12 | **Top-5** | Token Hardening |
| **R-05** | Service→Database | SQL injection attacks | T | **NFR-002** | 2 | ORM protection | 5 | Data breach | 10 | **Top-5** | Secure Database Access |