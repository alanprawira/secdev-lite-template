# S04 - DFD + STRIDE + Risk Prioritization

---

## DFD

```mermaid
flowchart LR
  %% === Trust boundaries ===
  subgraph Internet["Интернет / Внешние клиенты"]
    U[Клиент / Браузер / Мобильное]
  end

  subgraph Service["Сервис — приложение"]
    A[Public API / Auth Controller]
    S[Auth Service / Бизнес-логика]
  end

  subgraph Storage["Хранилище / Персистентный слой"]
    D[(База данных / Users и VerificationTokens)]
  end

  subgraph External["Внешние провайдеры"]
    X[Email Provider SMTP API]
  end

  %% === Основные потоки регистрации ===
  U -- "HTTPS JSON → POST /api/auth/register<br/>PII: email, password, ip<br/>[NFR-002 InputValidation, NFR-004 Privacy/PII]" --> A
  A -->|"DTO RegisterRequest + correlation_id<br/>[NFR-003 API-Contract]"| S
  S -->|"INSERT user (hash password), INSERT verification token<br/>SQL ORM<br/>[NFR-004 Privacy, Data-Integrity]"| D

  S -->|"HTTP/SMTP: email + verification token<br/>timeouts retry circuit-breaker<br/>[NFR-004 Privacy, Observability]"| X

  %% === Основные потоки верификации ===
  U -- "HTTPS → POST /api/auth/verify-email<br/>PII: email, token<br/>[NFR-001 RateLimiting, NFR-003 API-Contract]" --> A
  A -->|"DTO VerifyEmailRequest<br/>[NFR-003]"| S
  S -->|"SELECT token validation<br/>SQL ORM<br/>[Data-Integrity]"| D
  S -->|"UPDATE user.status=verified; DELETE token<br/>SQL ORM<br/>[NFR-004 Retention]"| D

  A -- "200/201 JSON или RFC7807 problem+json<br/>+ correlation_id<br/>[NFR-003, NFR-004]" --> U

  %% --- Оформление границ ---
  classDef boundary fill:#f6f6f6,stroke:#999,stroke-width:1px;
  class Internet,Service,Storage,External boundary;