# S04 - DFD + STRIDE + Risk Prioritization

---

## DFD

```mermaid
flowchart LR
  %% === Trust boundaries ===
  subgraph Internet["Интернет / Внешние клиенты"]
    U[Клиент / Браузер]
  end

  subgraph Service["Сервис — приложение"]
    A[Public API / Auth Controller]
    S[Auth Service / Бизнес-логика]
  end

  subgraph Storage["Хранилище"]
    D[(База данных)]
  end

  subgraph External["Внешние провайдеры"]
    X[Email Provider]
  end

  %% === Основные потоки ===
  U -- "POST /api/auth/register<br/>PII: email, password<br/>[NFR-002, NFR-004]" --> A
  A -->|"RegisterRequest DTO<br/>correlation_id [NFR-003]"| S
  S -->|"SQL INSERT user+token<br/>[NFR-004]"| D
  S -->|"Send email<br/>timeout/retry/CB"| X

  U -- "POST /api/auth/verify-email<br/>token [NFR-001]" --> A
  A -->|"VerifyEmailRequest DTO<br/>[NFR-003]"| S
  S -->|"SQL SELECT/UPDATE<br/>[NFR-004]"| D

  A -- "JSON/RFC7807 response<br/>correlation_id [NFR-003]" --> U

  %% --- Оформление границ ---
  classDef boundary fill:#f6f6f6,stroke:#999,stroke-width:2px;
  class Internet,Service,Storage,External boundary;
