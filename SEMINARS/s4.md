# S04 - DFD + STRIDE + Risk Prioritization

---

## DFD

```mermaid
flowchart LR
  %% === Trust boundaries ===
  subgraph Internet["Интернет / Внешние клиенты"]
    U[Клиент / Браузер]
  end

  subgraph Service["Сервис — приложение"]
    A[Public API / Auth Controller]
    S[Auth Service / Бизнес-логика]
  end

  subgraph Storage["Хранилище / Персистентный слой"]
    D[(База данных<br/>Users + VerificationTokens)]
  end

  subgraph External["Внешние провайдеры"]
    X[Email Provider<br/>SMTP API]
  end

  %% === Registration Flow ===
  U -- "POST /api/auth/register<br/>JSON: email, password<br/>[NFR-002 InputValidation]" --> A
  A -->|"RegisterRequest DTO<br/>correlation_id<br/>[NFR-003 API-Contract]"| S
  S -->|"INSERT user + token<br/>ORM parameters<br/>[NFR-004 Privacy]"| D
  S -->|"Send verification email<br/>timeout/retry/CB<br/>[NFR-004 Privacy]"| X

  %% === Email Verification Flow ===
  U -- "POST /api/auth/verify-email<br/>token, email<br/>[NFR-001 RateLimiting]" --> A
  A -->|"VerifyEmailRequest DTO<br/>[NFR-003]"| S
  S -->|"SELECT token validation<br/>[NFR-004 Data-Integrity]"| D
  
  S -->|"UPDATE user status<br/>DELETE token<br/>[NFR-004 Retention]"| D

  %% === Response Flow ===
  A -- "200/201 JSON или RFC7807<br/>correlation_id<br/>[NFR-003, NFR-004]" --> U

  %% --- Trust Boundaries ---
  classDef boundary fill:#f6f6f6,stroke:#999,stroke-width:2px;
  class Internet,Service,Storage,External boundary;
  ```

## STRIDE Matrix

| Element | Data/Boundary | Threat (S/T/R/I/D/E) | Description | NFR link (ID) | Mitigation idea (ADR later) |
|---------|---------------|---------------------|-------------|---------------|----------------------------|
| Edge: Internet → API (/register) | JSON Request | T | Manipulation of registration data - extra fields, oversized payload | **NFR-002** | Strict DTO schema validation, 64KiB limit enforcement |
| Edge: Internet → API (/register) | Public Endpoint | D | DoS through large payloads exceeding 64KiB limit | **NFR-002** | 413 responses for oversized requests per NFR-002 |
| Edge: Internet → API (/verify-email) | Verification Token | S | Token replay/bruteforce attacks | **NFR-001** | Rate limiting enforcement (3/min/IP) |
| Edge: Internet → API (/verify-email) | Public Endpoint | D | Abuse through request flooding exceeding rate limits | **NFR-001** | 429 responses with Retry-After per NFR-001 |
| Node: API Controller | Application Logs | I | PII leakage through verbose logging | **NFR-004** | PII masking in logs as per NFR-004 |
| Node: Auth Service | Error Handling | I | Information disclosure through detailed errors | **NFR-003** | RFC7807 errors, no stack traces per NFR-003 |
| Edge: Service → Database | SQL Queries | T | SQL injection through poor parameterization | **NFR-002** | Parameterized queries only, ORM protection |
| Node: Database | Stored Data | I | PII exposure through unencrypted storage | **NFR-004** | Encryption at rest, 30-day retention per NFR-004 |
| Edge: Service → Email Provider | SMTP/HTTP | D | Service degradation through external dependency failure | **NFR-004** | Timeouts, retries, circuit breaker for email delivery |
| Edge: API → Client | JSON Responses | I | Email enumeration through response differences | **NFR-003**, **NFR-004** | Neutral RFC7807 responses per NFR-003 |

---

## Risk Prioritization L×I

### Таблица приоритизации

| Risk ID | Source (DFD/Row) | Consolidated Description | Threat | NFR link (ID) | L | Rationale-L | I | Rationale-I | Score | Decision | ADR candidate |
|---------|------------------|-------------------------|--------|---------------|--|-------------|--|-------------|-------|----------|--------------|
| **R-01** | Internet→API (/register, /verify) | **Public endpoint DoS/abuse** - flooding and oversized requests exhausting resources | D | **NFR-001**, **NFR-002** | 4 | Public surface, easy automation | 4 | Service unavailability for onboarding | 16 | **Top-5** | Comprehensive Rate Limiting |
| **R-02** | Service→Email Provider | **External dependency failure** - email service hangs causing resource exhaustion | D | **NFR-004** | 4 | External services frequently unstable | 4 | Complete registration blockage | 16 | **Top-5** | External Service Resilience |
| **R-03** | API/Service Logs & Errors | **PII leakage through observability** - logs and errors expose sensitive data | I | **NFR-003**, **NFR-004** | 4 | Common misconfiguration, frequent generation | 4 | Mass PII exposure, compliance violations | 16 | **Top-5** | PII Protection & Masking |
| **R-04** | Database Token Storage | **Weak verification token security** - low entropy, long TTL, plaintext storage | S | **NFR-004** | 3 | Common implementation mistake | 4 | Account takeover for multiple users | 12 | **Top-5** | Token Hardening Strategy |
| **R-05** | Service→Database Queries | **SQL injection and data manipulation** - poor parameterization leads to data breaches | T | **NFR-002** | 2 | ORM reduces risk but manual queries exist | 5 | Complete data compromise, potential RCE | 10 | **Top-5** | Secure Database Access |
| **R-06** | API Request Processing | **Insufficient input validation** - extra fields, invalid states bypass business rules | T | **NFR-002** | 3 | Common during API evolution | 3 | Data corruption, state inconsistencies | 9 | Backlog | Strict Input Validation |
| **R-07** | Database Access Control | **Excessive database privileges** - service account has unnecessary permissions | E | **NFR-004** | 2 | Often configured for convenience | 5 | Mass data modification/deletion | 10 | Backlog | Least Privilege Database |
| **R-08** | Internet TLS | **Weak TLS configuration** - potential downgrade/MITM attacks | S/I | **NFR-004** | 2 | Modern stacks secure by default | 4 | PII/credential interception | 8 | Backlog | TLS Hardening Baseline |

### Консолидационные заметки

* **R-01** объединяет все DoS/abuse векторы на публичных эндпоинтах - напрямую связан с NFR-001 (RateLimiting) и NFR-002 (InputValidation)
* **R-03** консолидирует все PII утечки через логи, ошибки и ответы API - покрывает NFR-003 (API-Contract/Errors) и NFR-004 (Privacy/PII)
* **R-04** охватывает все аспекты безопасности токенов верификации - связан с NFR-004 приватностью и хранением данных
* **R-05** фокусируется на инъекциях и манипуляциях данных через уязвимости доступа к БД - основан на NFR-002 валидации входных данных
* Все риски напрямую связаны с NFR из S03, обеспечивая полную трассируемость требований

---

## Сводка Top-5 (итог для S05)

* **Top-1: R-01 — DoS/Abuse публичных auth-эндпоинтов**  
  **Почему:** L=4 (публичная поверхность, легкая автоматизация), I=4 (блокировка онбординга пользователей)  
  **ADR:** Comprehensive Rate Limiting Strategy

* **Top-2: R-02 — Отказ внешнего email-провайдера**  
  **Почему:** L=4 (нестабильность внешних сервисов), I=4 (полная остановка процесса регистрации)  
  **ADR:** External Service Resilience Pattern

* **Top-3: R-03 — Утечки PII через observability**  
  **Почему:** L=4 (частые ошибки конфигурации логирования), I=4 (массовая компрометация персональных данных)  
  **ADR:** PII Protection & Masking Framework

* **Top-4: R-04 — Слабая безопасность verification-токенов**  
  **Почему:** L=3 (требует определенных условий для эксплуатации), I=4 (компрометация учетных записей множества пользователей)  
  **ADR:** Token Hardening & Management

* **Top-5: R-05 — Инъекции и манипуляции БД**  
  **Почему:** L=2 (риск снижен использованием ORM), I=5 (критичный ущерб целостности данных)  
  **ADR:** Secure Database Access Controls

---

## Рекомендации для S05

* Сфокусироваться на ADR для топ-5 рисков с наибольшим impact на безопасность и доступность сервиса
* Рассмотреть компромиссы между безопасностью и usability при проектировании решений rate limiting
* Учесть compliance требования (GDPR) при проектировании PII protection framework
* Обеспечить backward compatibility при внедрении изменений в существующие API эндпоинты
* Приоритезировать реализацию mitigations на основе оценки L×I и бизнес-impact
* Установить метрики для мониторинга эффективности внедренных контролей
* Документировать принятые архитектурные решения в соответствии с форматом ADR
