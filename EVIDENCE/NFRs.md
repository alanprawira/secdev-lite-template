## US-001 - Регистрация пользователя

* **Роль-Цель-Ценность:** Как гость, я хочу зарегистрировать учётную запись, чтобы получить доступ к функционалу приложения.
* **Кратко:** Регистрация с подтверждением e-mail.
* **API/Endpoints (пример):** `POST /api/auth/register`, `POST /api/auth/verify-email`
* **NFR hooks:** `Security-AuthN`, `InputValidation`, `RateLimiting`, `API-Contract/Errors`, `Privacy/PII`

## US-002 - Вход в систему (Login)

* **Роль-Цель-Ценность:** Как пользователь, я хочу входить в систему по логину/паролю, чтобы управлять своими данными.
* **Кратко:** Вход, выдача JWT/сессии, защита от перебора.
* **API/Endpoints:** `POST /api/auth/login`
* **NFR hooks:** `Security-AuthN`, `RateLimiting`, `Timeouts/Retry`, `Observability/Logging`

## US-005 - Загрузка аватара/файла

* **Роль-Цель-Ценность:** Как пользователь, я хочу загрузить аватар, чтобы персонализировать профиль.
* **Кратко:** Проверка типа/размера, хранение под UUID.
* **API/Endpoints:** `POST /api/files/avatar`
* **NFR hooks:** `InputValidation`, `RateLimiting`, `Storage-Quotas`, `API-Contract/Errors`

## Таблица реестра

| ID | User Story / Feature | Category | Requirement (NFR) | Rationale / Risk | Acceptance (G-W-T) | Evidence (test/log/scan/policy) | Trace (issue/link) | Owner | Status | Priority | Severity | Tags |
|----|---------------------|----------|-------------------|------------------|-------------------|--------------------------------|-------------------|-------|--------|----------|----------|------|
| NFR-001 | US-001 - Регистрация пользователя | RateLimiting | На `POST /api/auth/verify-email` действует лимит 3 req/min на IP; превышение → 429 + Retry-After | Защита от DDoS и спама | **Given** IP адрес клиента<br>**When** выполняется 5 запросов к `/api/auth/verify-email` за 60 секунд<br>**Then** запросы 4-5 получают 429 и корректный заголовок Retry-After | e2e-тест лимита; логи с 429 и `Retry-After` | #SEC-001 | DevSecOps | Proposed | P1 - High | S2 - Major | инфраструктура,безопасность |
| NFR-002 | US-001 - Регистрация пользователя | Security-InputValidation | Для `POST /api/auth/register`: размер тела ≤ 64 KiB, `Content-Type=application/json`, разрешены только поля `{email, password}`; extra поля → 400; тело >64 KiB → 413 | Защита от DoS/грязных данных | **Given** тело запроса размером 128 KiB<br>**When** `POST /api/auth/register`<br>**Then** ответ 413 с телом в RFC 7807;<br>**Given** тело с полем `debug`<br>**When** `POST /api/auth/register`<br>**Then** 400 в RFC 7807; схема DTO отклоняет неизвестные поля | e2e: валидатор DTO; контракт-схема; логи 400/413 | #SEC-002 | Backend | Draft | P1 - High | S2 - Major | security,input,validation |
| NFR-003 | US-001 - Регистрация пользователя | API-Contract/Errors | Ошибки для `POST /api/auth/register` и `POST /api/auth/verify-email` отдаются в формате RFC 7807 (`application/problem+json`) без стэктрейсов; включён `correlation_id` | Предсказуемость API, отсутствие утечек | **Given** серверная ошибка при `POST /api/auth/register`<br>**When** клиент получает ответ<br>**Then** `Content-Type=application/problem+json`, присутствуют `type/title/status/detail`, нет стэктрейсов, есть `correlation_id` | контракт-тесты ошибок; пример problem+json в e2e | #API-001 | Backend | Proposed | P1 - High | S2 - Major | api-contract,errors,observability |
| NFR-004 | US-001 - Регистрация пользователя | Privacy/PII | PII (e-mail, IP, verification token) не логируются; сырые PII и незавершённые регистрации хранятся не дольше 30 дней | Приватность/комплаенс, снижение рисков утечки | **Given** DTO с `email` и `ip`<br>**When** выполняется логирование на любом уровне<br>**Then** поля PII замаскированы/отсутствуют;<br>**Given** учётная запись осталась неподтверждённой<br>**When** проходит 30 дней<br>**Then** запись и verification-токен удаляются согласно политике ретенции | пример логов с маскировкой; регламент ретенции; job лог | #PRIV-001 | DevSecOps | Proposed | P1 - High | S2 - Major | privacy,pii,compliance,retention |
| NFR-005 | US-002 - Вход в систему | Performance | P95 латентность для `POST /api/auth/login` ≤ 500ms при 200 RPS в течение 5 минут | UX/SLO для критичного пути аутентификации | **Given** сервис развернут и здоров<br>**When** на `/api/auth/login` подается 200 RPS в течение 5 минут<br>**Then** P95 ≤ 500ms и доля ошибок ≤ 1% | нагрузочный тест `load-auth-200rps`; метрики latency | #PERF-001 | Backend | Proposed | P1 - High | S2 - Major | performance,auth |
| NFR-006 | US-002 - Вход в систему | RateLimiting | На `POST /api/auth/login` действует лимит 10 req/min на IP; превышение → 429 + Retry-After | Защита от брутфорс-атак | **Given** IP адрес клиента<br>**When** выполняется 15 запросов к `/api/auth/login` за 60 секунд<br>**Then** запросы 11-15 получают 429 и заголовок Retry-After | e2e-тест лимита; логи аутентификации | #SEC-003 | DevSecOps | Proposed | P1 - High | S1 - Critical | security,ratelimit,auth |
| NFR-007 | US-002 - Вход в систему | Observability/Logging | Все запросы к `POST /api/auth/login` логируются в JSON и содержат `correlation_id`, `user_id` (после успешной аутентификации), результат (success/failure) | Трассировка и мониторинг безопасности | **Given** запрос с X-Correlation-ID=corr-123<br>**When** он проходит `POST /api/auth/login`<br>**Then** во всех логах correlation_id=corr-123 и поля user_id, result, timestamp | паттерн логов; запрос поиска по correlation_id | #OBS-001 | Backend | Draft | P2 - Medium | S2 - Major | observability,logging,security |
| NFR-008 | US-005 - Загрузка аватара | Security-InputValidation | Для `POST /api/files/avatar`: размер тела ≤ 2 MiB, MIME только `image/jpeg`, `image/png`, `image/gif`; extra поля запрещены | Защита от DoS и инъекций через файлы | **Given** файл 5 MiB<br>**When** `POST /api/files/avatar`<br>**Then** 413 с RFC7807;<br>**Given** файл с MIME `application/pdf`<br>**When** `POST /api/files/avatar`<br>**Then** 400 с описанием ошибки валидации | e2e-тест валидации файлов; схема валидации MIME | #SEC-004 | Backend | Proposed | P2 - Medium | S2 - Major | security,validation,files |
| NFR-009 | US-005 - Загрузка аватара | RateLimiting | На `POST /api/files/avatar` действует лимит 5 req/min на пользователя; превышение → 429 + Retry-After | Защита от злоупотребления ресурсами | **Given** аутентифицированный пользователь<br>**When** выполняется 7 запросов к `/api/files/avatar` за 60 секунд<br>**Then** запросы 6-7 получают 429 и заголовок Retry-After | e2e-тест лимита; логи загрузки файлов | #SEC-005 | DevSecOps | Draft | P2 - Medium | S2 - Major | security,ratelimit,storage |
| NFR-010 | US-005 - Загрузка аватара | Performance | P95 латентность для `POST /api/files/avatar` ≤ 2s при 50 RPS в течение 3 минут | UX для операций с файлами | **Given** сервис развернут и здоров<br>**When** на `/api/files/avatar` подается 50 RPS в течение 3 минут<br>**Then** P95 ≤ 2s и доля ошибок ≤ 2% | нагрузочный тест `load-avatar-50rps`; метрики обработки файлов | #PERF-002 | Backend | Draft | P2 - Medium | S2 - Major | performance,files,storage |
| NFR-011 | US-002 - Вход в систему | Security-AuthN | JWT access token TTL = 15 минут, refresh token TTL = 7 дней; ключи ротируются каждые 90 дней через JWKS | Защита от компрометации токенов и replay атак | **Given** истёкший access token<br>**When** запрос к защищенному эндпойнту<br>**Then** 401 с RFC7807;<br>**Given** валидный refresh token<br>**When** вызов `/api/auth/refresh`<br>**Then** новый access token с обновленным exp | интеграционные тесты токенов; аудит rotation событий | #SEC-006 | Backend | Proposed | P1 - High | S1 - Critical | security,jwt,authn |
| NFR-012 | US-001 - Регистрация пользователя | Timeouts/Retry/CircuitBreaker | Вызовы к Email Provider: timeout ≤ 2s, retry ≤ 3 с jitter, circuit breaker при error-rate ≥50%/1min | Устойчивость к отказам внешних сервисов | **Given** зависание email сервиса<br>**When** вызов отправки verification email<br>**Then** суммарно ≤ 6s, retry ≤ 3, CB активируется | мониторинг timeout/retry метрик; логи circuit breaker | #RES-001 | Backend | Proposed | P1 - High | S2 - Major | resilience,timeouts,external |
